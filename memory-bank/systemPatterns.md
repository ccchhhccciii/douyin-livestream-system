# 抖音电商无人直播系统 - 系统架构

## 整体架构
采用模块化、事件驱动的架构设计，通过 **Redis Pub/Sub 消息队列** 实现模块间通信，保证系统松耦合和高可扩展性。
┌──────────────────────┐ ┌──────────────────────┐ ┌──────────────────────┐
│     PyQt6 UI模块     │ │     话术生成模块     │ │ WebSocket服务 (独立进程) │
└──────────┬───────────┘ └──────────┬───────────┘ └──────────┬───────────┘
           │                        │                        │
┌──────────▼───────────┬────────────▼───────────┬────────────▼───────────┐
│                 Redis Pub/Sub 消息队列                                │
└──────────┬───────────┬────────────┬───────────┬────────────┬───────────┘
           │           │            │           │            │
┌──────────▼──────────┐ ┌───────────▼──────────┐ ┌───────────▼──────────┐
│    调度控制模块     │ │     TTS系统模块      │ │    内容安全模块     │
└─────────────────────┘ └──────────────────────┘ └──────────────────────┘
           ▲                        ▲
           │                        │
┌──────────┴──────────┐ ┌───────────┴──────────┐
│  变体模板解析模块   │ │   变体模板生成模块   │
└─────────────────────┘ └──────────────────────┘

变体模板系统扩展了原有架构，添加了模板生成和解析模块，增强了话术的多样性和灵活性。

## WebSocket服务架构
WebSocket服务作为一个独立进程运行，内部采用了多层架构，分离了连接管理、消息解析和互动处理逻辑，并通过 Redis Pub/Sub 发布清理后的消息：

┌─────────────────────────────────────────────────────────────────────┐
│                         WebSocketClient                             │
│  ┌──────────────────┐   ┌────────────────┐   ┌──────────────────┐  │
│  │  连接管理与重连  │-->│ 消息接收与分发 │-->│ 异步处理与回调  │  │
│  └──────────────────┘   └────────────────┘   └──────────────────┘  │
└─────────────────┬───────────────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         MessageParser                               │
│  ┌──────────────────┐   ┌────────────────┐   ┌──────────────────┐  │
│  │    消息解析      │-->│ 用户数据提取   │-->│  消息类型分类   │  │
│  └──────────────────┘   └────────────────┘   └──────────────────┘  │
│  ┌──────────────────┐   ┌────────────────┐                         │
│  │  内容过滤与清理  │<--│  数据验证      │                         │
│  └──────────────────┘   └────────────────┘                         │
└─────────────────┬───────────────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      InteractionProcessor                           │
│  ┌──────────────────┐   ┌────────────────┐   ┌──────────────────┐  │
│  │  优先级队列管理  │<--│  互动事件创建  │<--│  消息预处理     │  │
│  └────────┬─────────┘   └────────────────┘   └──────────────────┘  │
│           │                                  ┌──────────────────┐  │
│           ▼                                  │ 用户活跃度跟踪   │  │
│  ┌──────────────────┐   ┌────────────────┐  └──────────────────┘  │
│  │  响应生成        │-->│  回调机制      │                         │
│  └──────────────────┘   └────────────────┘                         │
└─────────────────────────────────────────────────────────────────────┘

## LLM响应生成系统架构
LLM响应生成系统整合了火山引擎API，实现了高质量的互动回复：

┌─────────────────────────────────────────────────────────────────────┐
│                          LLM响应生成系统                            │
│  ┌──────────────────┐   ┌────────────────┐   ┌──────────────────┐  │
│  │  响应提示词模板  │-->│ LLM客户端管理  │-->│  响应处理与过滤 │  │
│  └──────────────────┘   └────────────────┘   └──────────────────┘  │
│                             │                                       │
│  ┌──────────────────┐   ┌───▼────────────┐   ┌──────────────────┐  │
│  │ 响应缓存与复用   │<--│ 火山引擎客户端 │-->│  异步请求处理   │  │
│  └──────────────────┘   └────────────────┘   └──────────────────┘  │
│                             │                                       │
│  ┌──────────────────┐   ┌───▼────────────┐   ┌──────────────────┐  │
│  │ 错误处理与重试   │<--│  Ollama客户端  │-->│  流式响应处理   │  │
│  └──────────────────┘   └────────────────┘   └──────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘

## TTS系统架构
TTS系统实现了分层设计，确保高质量音频生成和灵活的播放控制：

┌─────────────────────────────────────────────────────────────────────┐
│                            TTS系统                                  │
│  ┌──────────────────┐   ┌────────────────┐   ┌──────────────────┐  │
│  │    TTS队列管理   │-->│  TTS生成引擎   │-->│  音频质量控制   │  │
│  └──────────────────┘   └────────────────┘   └──────────────────┘  │
│                                                        │            │
│  ┌──────────────────┐   ┌────────────────┐   ┌────────▼─────────┐  │
│  │    优先级控制    │<--│  音频播放器    │<--│   音频后处理    │  │
│  └──────────────────┘   └────────────────┘   └──────────────────┘  │
│          │                     │                                    │
│  ┌───────▼──────────┐   ┌─────▼──────────┐   ┌──────────────────┐  │
│  │  动态打断决策    │-->│  分块播放控制  │-->│  缓存与优化     │  │
│  └──────────────────┘   └────────────────┘   └──────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘

## 设计模式
1. **观察者模式**：通过事件总线实现组件间通信
2. **策略模式**：动态选择不同的话术生成、变体解析和TTS策略
3. **命令模式**：封装任务请求，支持队列、优先级和撤销
4. **工厂模式**：创建不同类型的话术生成器、变体解析器和处理器
5. **单例模式**：确保事件总线、配置管理器等全局唯一
6. **适配器模式**：封装不同LLM API及GPT-SoVITS API，提供统一接口
7. **解释器模式**：解析变体模板中的标记语法并生成最终话术
8. **组合模式**：处理变体标记的嵌套结构和层次关系
9. **装饰器模式**：动态添加消息处理和过滤功能
10. **优先级队列模式**：高效处理不同级别重要性的互动消息
11. **中间件模式**：实现TTS前后处理的可插拔处理链
12. **状态模式**：管理音频播放器的不同状态与转换
13. **责任链模式**：处理VAD检测和重试决策链
14. **备忘录模式**：保存和恢复被打断的音频播放状态

## WebSocket模块设计模式

1. **异步多线程模式**：
   - WebSocket连接在独立线程中运行
   - 使用事件循环处理异步消息接收
   - 主线程不被网络操作阻塞
   - 使用线程安全机制协调跨线程通信

2. **责任链模式**：
   - 消息经过多级处理链
   - 连接层 → 解析层 → 过滤层 → 处理层
   - 每层可独立决定是否将消息传递到下一层
   - 便于在不同阶段插入处理逻辑

3. **过滤器模式**：
   - 消息通过多种过滤规则
   - 支持黑名单关键词过滤
   - 用户级别和粉丝数过滤
   - 特定角色过滤（管理员、主播等）

4. **优先级处理模式**：
   - 基于消息类型和内容分配优先级
   - 使用堆实现的优先级队列
   - 高优先级消息（礼物、关注）先处理
   - 防止重要互动被普通消息淹没

5. **状态跟踪模式**：
   - 维护用户活跃状态
   - 跟踪互动历史
   - 超时自动清理机制
   - 为个性化响应提供上下文

## LLM响应生成模式

1. **装饰器与策略模式**：
   - 使用装饰器模式为响应添加格式化、过滤等功能
   - 实现多种响应策略，如礼物感谢、问题回答、常规互动等
   - 根据消息类型动态选择适当的响应策略

2. **异步请求与回调模式**：
   - LLM请求采用异步模式执行，不阻塞UI线程
   - 使用回调函数处理完成的响应
   - 实现请求超时和错误重试机制

3. **模板引擎模式**：
   - 响应提示词使用模板化设计
   - 提供上下文信息注入机制
   - 支持产品信息、用户数据等动态替换

4. **缓存与复用策略**：
   - 实现LRU缓存机制存储常见问题的响应
   - 基于问题相似度匹配缓存响应
   - 设置缓存失效机制确保信息时效性

5. **适配器模式扩展**：
   - 为火山引擎和Ollama实现统一的接口
   - 自动处理不同API格式和参数差异
   - 灵活切换不同模型提供商

## TTS系统设计模式与架构

1. **多层次队列管理**：
   - 文本队列：管理待处理的文本条目，支持优先级排序
   - TTS处理队列：控制并行TTS生成任务
   - 音频播放队列：管理待播放的音频文件，支持插队和打断

2. **非阻塞VAD检测与中间件链**：
   - 前处理中间件：文本预处理、分段和规范化
   - 生成中间件：TTS请求处理和模型选择
   - 后处理中间件：VAD检测、音频增强、特效处理
   - 使用异步处理避免阻塞主流程

3. **智能重试与模型轮换**：
   - 检测到无声音频时自动触发重试
   - 每次重试使用不同的TTS模型
   - 实现指数退避策略控制重试频率
   - 达到最大重试次数后使用备用方案

4. **分块音频播放与状态管理**：
   - 将长音频分割为小块独立处理
   - 维护播放状态机管理不同播放状态
   - 支持精确控制播放、暂停和中断
   - 允许高优先级任务平滑打断当前播放

5. **动态优先级计算**：
   - 基础优先级：根据消息类型（礼物、评论、关注）
   - 用户因素：考虑用户等级、活跃度和历史互动
   - 内容因素：分析消息关键词和情感
   - 时间因素：考虑消息新鲜度和响应延迟

6. **音频缓存与优化**：
   - 基于MD5哈希的音频缓存机制
   - LRU缓存淘汰策略
   - 定期清理过期缓存
   - 预生成常用响应音频

## TTS播放状态机
```
          ┌─────────┐
          │  空闲   │
          └────┬────┘
               │ 收到音频
               ▼
┌─────────────────────────────┐
│          播放中             │◄────┐
└──────────────┬──────────────┘     │ 恢复播放
               │ 收到高优先级音频   │
               ▼                    │
┌─────────────────────────────┐     │
│          中断决策           │     │
└──────────────┬──────────────┘     │
               │                    │
               ▼                    │
┌─────────────────────────────┐     │
│          已中断             ├─────┘
└──────────────┬──────────────┘ 
               │ 中断音频播放完成
               ▼
┌─────────────────────────────┐
│        中断后处理           │
└──────────────┬──────────────┘
               │
               ▼
         ┌───────────┐
         │ 播放完成  │
         └───────────┘
```

## 核心组件关系
1. **UI与业务逻辑分离**：
   - UI组件只负责显示和用户交互
   - 业务逻辑通过独立模块实现
   - 通过事件总线通信

2. **话术生成与变体系统**：
   - 话术生成器创建基础销售话术
   - 变体模板生成器将话术转换为带变体标记的模板
   - 变体解析引擎实时解析模板生成差异化话术

3. **话术处理与TTS流程**：
   - 基础话术/变体模板生成
   - 变体解析引擎处理模板
   - 解析后的文本进入TTS队列
   - TTS处理后生成音频
   - 音频进入播放队列

4. **互动处理流程**：
   - WebSocket接收互动
   - 消息解析器提取关键信息
   - 内容安全模块过滤
   - 互动处理器分析并生成回复
   - 回复文本进入TTS队列
   - 生成音频后播放

5. **调度与优先级**：
   - 紧急互动 > 普通互动 > 背景话术
   - 队列管理器动态调整优先级
   - 防止资源竞争和阻塞

## TTS与音频处理组件关系

1. **TTSQueueManager与AudioVADDetector**：
   - 队列管理器负责TTS任务调度
   - 生成音频后由VAD检测器验证质量
   - 检测到无声音频时触发重新生成
   - 实现异步检测避免处理瓶颈

2. **TTSQueueManager与ChunkBasedAudioPlayer**：
   - 队列管理器将生成的音频传递给播放器
   - 播放器根据优先级决定是否立即播放
   - 高优先级任务可以中断当前播放
   - 维护被中断任务状态允许后续恢复

3. **AudioVADDetector与多模型策略**：
   - VAD检测失败时通知队列管理器
   - 队列管理器启动多模型轮换策略
   - 不同的TTS模型适用于不同类型文本
   - 记录模型成功率优化模型选择

4. **ChunkBasedAudioPlayer与状态管理**：
   - 播放器维护内部状态机
   - 处理播放、中断和恢复逻辑
   - 通过回调通知播放状态变化
   - 支持多种播放终止条件

## WebSocket服务组件关系

1. **WebSocketClient与MessageParser**：
   - 客户端负责连接管理和消息接收
   - 消息解析器负责JSON解析和数据提取
   - 客户端将原始消息传递给解析器
   - 解析器返回结构化的消息对象

2. **MessageParser与MessageCleaner**：
   - 解析器生成标准化的消息格式
   - 消息清理器接收解析后的消息
   - 根据业务规则过滤和清理消息（例如，只保留评论文本）
   - 清理器返回清理后的内容（例如，评论文本字符串）

3. **WebSocketWorker与Redis Pub/Sub**：
   - WebSocketWorker 在独立线程中运行 WebSocketClient
   - Worker 接收 WebSocketClient 发出的清理后消息
   - Worker 将清理后的消息发布到 Redis Pub/Sub 频道

4. **Redis Pub/Sub 与其他模块**：
   - 其他需要 WebSocket 消息的模块（如互动处理模块、调度控制模块）订阅 Redis Pub/Sub 频道
   - 模块接收并处理来自 Redis 的消息

## LLM响应系统与其他模块关系
1. **消息流转**：
   - 互动处理器识别需要LLM响应的消息
   - 创建响应请求并提供必要上下文
   - LLM响应系统处理请求并生成回复
   - 回复返回给互动处理器进行后续处理

2. **上下文管理**：
   - 互动处理器提供用户历史互动记录
   - LLM响应系统整合产品信息和直播状态
   - 共同维护对话上下文连贯性
   - 实现上下文感知的个性化响应

3. **优先级调度协作**：
   - 互动处理器为响应请求分配优先级
   - LLM响应系统根据优先级调度处理顺序
   - 重要互动（礼物、关注）获得更高优先级
   - 系统负载高时优先处理高价值互动

## 直播工作流数据流 (更新)

```mermaid
graph LR
    A[直播平台] --> B(WebSocket服务);
    B --> C(Redis Pub/Sub);
    C --> D[消息消费者 (其他模块)];
    D --> E[互动处理];
    E --> F[LLM响应生成];
    F --> G[文本队列];
    G --> H[TTS生成];
    H --> I[VAD检测];
    I --> J[音频播放];
    J --> K[音频输出];
```

## 数据流设计 (更新)
1. **输入数据流**：
   - 产品信息 → 话术生成 → 基础话术
   - 基础话术 → 变体模板生成 → 变体模板
   - 直播平台 → WebSocket服务 → 清理后评论 (通过 Redis Pub/Sub)

2. **话术流**：
   - 变体模板 → 变体解析引擎 → 解析后话术
   - 解析后话术 → 内容安全过滤 → 最终话术

3. **处理数据流**：
   - 话术/回复 (来自 Redis Pub/Sub 或其他内部逻辑) → TTS队列 → 音频生成
   - 音频文件 → VAD检测 → 质量验证
   - 合格音频 → 音频队列 → 播放控制

4. **WebSocket数据流**：
   - 直播平台 → WebSocket服务 (独立进程) → 原始JSON消息
   - 原始消息 → 消息解析器 → 结构化消息
   - 结构化消息 → 消息清理器 → 清理后评论文本
   - 清理后评论文本 → Redis Pub/Sub → 其他模块

5. **LLM响应数据流**：
   - 互动消息 (来自 Redis Pub/Sub) → 提示词模板填充 → 完整提示词
   - 提示词 → LLM客户端 → 火山引擎/Ollama
   - LLM响应 → 格式化处理 → 最终用户回复
   - 响应缓存 → 类似问题复用 → 减少API调用

6. **TTS处理流**：
   - 文本输入 (来自 LLM响应 或其他逻辑) → 文本预处理 → 分段处理
   - 处理后文本 → TTS引擎 → 原始音频
   - 原始音频 → VAD检测 → 质量评估
   - 低质量音频 → 重试策略 → 模型轮换
   - 合格音频 → 后处理增强 → 最终音频
   - 最终音频 → 分块处理 → 播放队列

7. **音频播放流**：
   - 音频块 → 优先级排序 → 播放队列
   - 播放队列 → 状态管理 → 播放/暂停/中断
   - 状态变化 → 事件通知 → UI更新
   - 播放完成 → 队列前移 → 下一块播放

8. **存储数据流**：
   - 产品信息存储：JSON → 产品目录
   - 话术存储：基础话术 → 变体模板 → 持久化存储
   - 音频缓存：生成 → 验证 → 缓存管理
   - 互动历史：互动事件 → 临时存储 → 统计分析
   - 响应缓存：LLM响应 → 键值存储 → 定期失效

## 扩展点 (更新)
1. **多TTS引擎支持**：预留适配不同TTS系统的接口
2. **多平台支持**：架构设计考虑未来支持更多直播平台
3. **自定义话术策略**：支持插件式话术生成策略
4. **变体解析策略**：已实现多种变体选择算法（随机、权重、轮换），可扩展更多自定义策略
5. **高级互动规则**：可扩展的互动规则引擎
6. **多LLM提供商**：灵活切换不同的语言模型提供商
7. **消息过滤扩展**：可定制的过滤规则和黑名单关键词
8. **互动响应策略**：可插拔的响应策略，支持不同场景下的互动方式
9. **用户分析扩展**：可增加用户画像和行为分析模块
10. **TTS质量控制扩展**：可扩展的VAD检测和音频增强模块
11. **动态优先级策略**：可自定义的优先级计算规则
12. **高级中断恢复策略**：可扩展的决策算法控制播放中断和恢复
13. **消息队列适配器**：为支持其他消息队列系统预留接口
14. **服务发现与注册**：考虑在微服务架构下引入服务发现机制

## 技术决策理由 (更新)
1. **PyQt6选择**：提供丰富UI组件和良好跨平台支持
2. **Redis Pub/Sub**：轻量级、易于集成，适合模块间松耦合通信
3. **多级队列**：平衡及时性和系统资源
4. **异步设计**：提高响应性，避免UI阻塞
5. **变体标记语法**："{选项1|选项2}"格式简洁明了，便于LLM生成和后续解析
6. **产品数据层次结构**：按产品ID组织目录，便于管理和扩展
7. **双LLM提供商支持**：平衡本地部署和云端能力，提高系统灵活性
8. **WebSocket服务独立进程**：实现模块解耦、提高稳定性和可伸缩性
9. **优先级队列处理互动**：确保重要互动不被忽略，提高直播互动质量
10. **用户活跃度跟踪**：优化互动体验，识别重要用户
11. **火山引擎API优先**：提供高质量中文回复，专为中文内容优化
12. **异步LLM请求处理**：避免UI线程阻塞，保持系统响应性
13. **分块音频处理**：相比整体处理更灵活，支持精细控制和中断
14. **VAD技术集成**：提高TTS质量，减少无声音频问题
15. **中间件设计**：使TTS处理流程可扩展，便于添加新功能
16. **状态机模型**：使音频播放系统更健壮，严格控制状态转换
17. **多模型轮换策略**：不同模型有不同优势，通过轮换提高成功率
